<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="portal_my_home_service_booking" name="Portal My Home Service Booking"
        inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[@id='portal_common_category']" position="inside">
            <div t-if="service_booking_count" class="o_portal_index_card col-md-6 order-2">
                <a href="/my/service-bookings" title="My Service Bookings" class="d-flex gap-2 gap-md-3 py-3 pe-2 px-md-3 h-100 rounded text-decoration-none bg-100">
                    <div class="o_portal_icon d-block align-self-start">
                        <img src="/web/static/img/folder.svg" loading="lazy" alt="Service Booking Icon"/>
                    </div>
                    <div>
                        <div class="mt-0 mb-1 fs-5 fw-normal lh-1 d-flex gap-2">
                            <span class="d-none" data-placeholder_count="service_booking_count">0</span>
                            <span>My Service Bookings</span>
                        </div>
                        <div class="opacity-75">
                            View your past and current service bookings.
                        </div>
                    </div>
                </a>
            </div>
        </xpath>
    </template>

    <template id="my_service_bookings_list_template" name="My Service Bookings List">
        <t t-call="portal.portal_layout">
            <h3 class="mb-4">My Service Bookings</h3>

            <div t-if="not service_bookings" class="alert alert-info text-center mt-3">
                You have no service bookings yet.
            </div>
            <div t-else="" class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Booking Number</th>
                            <th>Booking Date</th>
                            <th>Vehicle</th>
                            <th>Plate Number</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="service_bookings" t-as="booking">
                            <tr>
                                <td>
                                    <t t-if="booking.record_type == 'appointment'">
                                        <t t-esc="booking.name"/>
                                    </t>
                                    <t t-else="">
                                        <a t-att-href="booking.get_portal_url()"><t t-esc="booking.name"/></a>
                                    </t>
                                </td>
                                <td><t t-esc="booking.plan_service_date" t-options='{"widget": "date"}'/></td>
                                <td><t t-esc="booking.vehicle_brand.name"/> <t t-esc="booking.vehicle_model.name"/></td>
                                <td><t t-esc="booking.plat_number"/></td>
                                <td>
                                    <span t-attf-class="badge bg-#{booking.state == 'completed' and 'success' or booking.state == 'in_progress' and 'info' or booking.state == 'assigned' and 'warning' or booking.state == 'cancelled' and 'danger' or booking.state == 'booked' and 'primary' or 'light'}">
                                        <t t-esc="booking.state"/>
                                    </span>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>

            <div t-if="pager" class="o_portal_pager text-center">
                <t t-call="portal.pager"/>
            </div>
        </t>
    </template>

    <template id="my_service_bookings_detail_template" name="Service Booking Details">
        <t t-call="portal.portal_layout">
            <div class="card o_portal_my_doc shadow-sm">
                <div class="card-body p-3 p-lg-4">

                    <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
                        <h2 class="mb-2">
                            Service Booking: <span t-field="booking.name"/>
                        </h2>

                        <div class="o_portal_return_buy">
                            <a t-if="back_url" t-att-href="back_url" class="btn btn-secondary">
                                <i class="fa fa-chevron-left me-1"/> Back to My Service Bookings
                            </a>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-12 col-lg-6 mb-3">
                            <h4 class="my-4">Booking Information</h4>
                            <div class="bg-body">
                                <p class="mb-3"><strong>Booking Number:</strong> <span t-field="booking.name"/></p>
                                <p class="mb-3">
                                    <strong>Status:</strong>
                                    <span t-attf-class="badge rounded-pill text-bg-#{booking.state == 'completed' and 'success' or booking.state == 'in_progress' and 'info' or booking.state == 'assigned' and 'warning' or booking.state == 'cancelled' and 'danger' or 'primary'}">
                                        <span t-field="booking.state"/>
                                    </span>
                                </p>
                                <p class="mb-3"><strong>Planned Service Date:</strong> <span t-field="booking.plan_service_date" t-options='{"widget": "date"}'/></p>
                                <p class="mb-3"><strong>Service Type:</strong> <span t-field="booking.service_type.name"/></p>
                                <p class="mb-2"><strong>Complaints:</strong> <span t-field="booking.complaint_issue"/></p>
                            </div>
                        </div>

                        <div class="col-12 col-lg-6 mb-3">
                            <h4 class="my-4">Vehicle Information</h4>
                            <div class="bg-body">
                                <p class="mb-3"><strong>Brand:</strong> <span t-field="booking.vehicle_brand.name"/></p>
                                <p class="mb-3"><strong>Model:</strong> <span t-field="booking.vehicle_model.name"/></p>
                                <p class="mb-3"><strong>Plate Number:</strong> <span t-field="booking.plat_number"/></p>
                                <p class="mb-3"><strong>Year:</strong> <span t-field="booking.vehicle_year_manufacture"/></p>
                                <p class="mb-2"><strong>Kilometers:</strong> <span t-field="booking.kilometers"/></p>
                            </div>
                        </div>
                    </div>  

                    <div t-if="booking.spare_part_line_ids or booking.service_line_ids" class="mb-4">
                        <h4 class="mb-3">Summary of Charges</h4>

                        <div class="table-responsive border rounded">
                            <table class="table table-md table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th class="text-end">Quantity</th>
                                        <th class="text-end">Unit Price</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="booking.spare_part_line_ids" t-as="part_line">
                                        <tr>
                                            <td><span t-field="part_line.product_id.name"/> (Part)</td>
                                            <td class="text-end"><span t-field="part_line.qty"/></td>
                                            <td class="text-end"><span t-field="part_line.unit_price" t-options="{'widget': 'monetary', 'display_currency': booking.currency_id}"/></td>
                                            <td class="text-end"><span t-field="part_line.subtotal" t-options="{'widget': 'monetary', 'display_currency': booking.currency_id}"/></td>
                                        </tr>
                                    </t>
                                    <t t-foreach="booking.service_line_ids" t-as="service_line">
                                        <tr>
                                            <td><span t-field="service_line.product_id.name"/> (Service)</td>
                                            <td class="text-end"><span t-field="service_line.qty"/></td>
                                            <td class="text-end"><span t-field="service_line.unit_price" t-options="{'widget': 'monetary', 'display_currency': booking.currency_id}"/></td>
                                            <td class="text-end"><span t-field="service_line.subtotal" t-options="{'widget': 'monetary', 'display_currency': booking.currency_id}"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total Spareparts:</strong></td>
                                        <td class="text-end"><strong><span t-field="booking.total_sparepart" t-options="{'widget': 'monetary', 'display_currency': booking.currency_id}"/></strong></td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total Service Fee:</strong></td>
                                        <td class="text-end"><strong><span t-field="booking.total_service_fee" t-options="{'widget': 'monetary', 'display_currency': booking.currency_id}"/></strong></td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                                        <td class="text-end"><strong><span t-field="booking.total_amount" t-options="{'widget': 'monetary', 'display_currency': booking.currency_id}"/></strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="text-end mt-3">
                            <a t-if="booking.invoice_id"
                            t-att-href="booking.invoice_id.get_portal_url()"
                            class="btn btn-primary">
                                View Invoice
                            </a>
                        </div>
                    </div>

                    <div t-if="booking.inspection_checklist_line_ids" class="mb-0">
                        <h4 class="mb-3">Inspection Checklist</h4>
                        <ul class="list-group">
                            <t t-foreach="booking.inspection_checklist_line_ids" t-as="checklist_line">
                                <t t-if="checklist_line.checklist_ok">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span t-field="checklist_line.inspection_type_id.name"/>
                                        <span t-attf-class="badge rounded-pill text-bg-#{checklist_line.checklist_ok and 'success' or 'danger'}">
                                            <t t-if="checklist_line.checklist_ok">OK</t>
                                            <t t-else="">N/A</t>
                                        </span>
                                    </li>
                                </t>
                            </t>
                        </ul>
                    </div>

                </div>
            </div>
        </t>
    </template>

    <template id="portal_my_service_bookings_breadcrumbs" inherit_id="portal.portal_breadcrumbs" priority="40">
        <xpath expr="//ol[@class='o_portal_submenu breadcrumb mb-0 flex-grow-1 px-0']" position="inside">
            <li t-if="page_name == 'service_booking' or page_name == 'service_booking_detail'" class="breadcrumb-item">
                <a t-att-href="default_url">My Service Bookings</a>
            </li>
            <li t-if="page_name == 'service_booking_detail'" class="breadcrumb-item active">
                <span t-field="booking.name"/>
            </li>
        </xpath>
    </template>
</odoo>